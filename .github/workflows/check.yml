name: CI/CD Pipeline üöÄ

on:
  push:
    branches: [ "main" ]

jobs:
  build-image:
    name: Build Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build Docker Image
        run: docker build -t test-bot-image .

  deploy:
    name: Deploy to AWS
    needs: build-image
    runs-on: ubuntu-latest

    steps:
      - name: Deploy using SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          ENV_FILE: ${{ secrets.ENV_FILE }}  # 1. –ë–µ—Ä–µ–º–æ —Å–µ–∫—Ä–µ—Ç –∑ GitHub
        with:
          host: ${{ secrets.EC2_HOST }}          # ‚ö†Ô∏è –ü–µ—Ä–µ–≤—ñ—Ä, —á–∏ —Ç–≤—ñ–π —Å–µ–∫—Ä–µ—Ç –Ω–∞–∑–∏–≤–∞—î—Ç—å—Å—è HOST —á–∏ EC2_HOST
          username: ${{ secrets.USERNAME }}  # ‚ö†Ô∏è –ó–∞–∑–≤–∏—á–∞–π —Ü–µ "ubuntu"
          key: ${{ secrets.KEY }}            # ‚ö†Ô∏è –¢–≤—ñ–π SSH –∫–ª—é—á
          port: 22
          envs: ENV_FILE                     # 2. –ü–µ—Ä–µ–¥–∞—î–º–æ –∑–º—ñ–Ω–Ω—É –≤—Å–µ—Ä–µ–¥–∏–Ω—É SSH-—Å–µ—Å—ñ—ó
          script: |
            # –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Git
            git config --global --add safe.directory /home/ubuntu/docker_compose_bot
            
            cd docker_compose_bot
            
            # üî• 3. –ì–û–õ–û–í–ù–ê –ú–ê–ì–Ü–Ø: –°—Ç–≤–æ—Ä—é—î–º–æ —Ñ–∞–π–ª .env —ñ–∑ —Å–µ–∫—Ä–µ—Ç—É
            echo "$ENV_FILE" > .env
            
            # –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–¥—É
            git fetch origin
            git reset --hard origin/main
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ (–∑ –±—ñ–ª–¥–æ–º, —â–æ–± –ø—ñ–¥—Ö–æ–ø–∏—Ç–∏ –Ω–æ–≤—ñ –ª—ñ–±–∏, —è–∫—â–æ —î)
            docker compose down
            docker compose build --no-cache
            docker compose up -d